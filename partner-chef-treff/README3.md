Якщо в категорій **формально** є товари (опубліковані), але **для даного користувача** вони всі приховані (через Product Visibility, ролі, або інші фільтри), то стандартна опція `hide_empty => true` у `get_terms()` це **не** відобразить, бо «hide_empty» дивиться на опубліковані товари в базі, а не враховує «видимість для користувача».

В результаті категорія **не порожня** формально, але **користувач** у ній реальних «видимих» продуктів не бачить. Тож категорія залишається в списку, а товари у ній «неактивні».

### Що зробити, щоб **ховати** такі «порожні для користувача» категорії:

1. **Зробити власну перевірку**, чи в категорії є хоча б один товар, **видимий** поточному користувачу. Якщо **немає** → не виводимо категорію.

2. **Окрема логіка**: «hide_empty => true» показує категорію, якщо у ній є опубліковані товари. Але, якщо ці товари всі приховані через логіку ролей (чи інших фільтрів), WooCommerce не знає, що для цього користувача категорія «порожня». Тому стандартні аргументи `get_terms()` цього не вирішать.

---

## Як реалізувати «Перевірити наявність видимих товарів» вручну

1. Отримуємо категорії:
   ```php
   $args = [
       'taxonomy'   => 'product_cat',
       'orderby'    => 'name',
       'order'      => 'ASC',
       'hide_empty' => true,
   ];
   $product_categories = get_terms($args);
   ```

2. Для **кожної** категорії робимо пошук (WP_Query або `wc_get_products`) **першого** товару, який **дійсно** видимий для користувача:

   ```php
   foreach ($product_categories as $category) {
       // Перевіряємо, чи в категорії є принаймні 1 товар
       // видимий для поточного користувача
       $has_visible_product = category_has_visible_product($category->term_id);

       if ($has_visible_product) {
           // Виводимо категорію
       }
   }
   ```

3. Реалізація функції `category_has_visible_product($term_id)`. Можливий варіант:

   ```php
   function category_has_visible_product($term_id) {
       // Беремо товари в цій категорії
       $args = [
           'post_type'      => 'product',
           'posts_per_page' => 1,           // шукаємо хоча б один
           'tax_query'      => [
               [
                   'taxonomy' => 'product_cat',
                   'field'    => 'term_id',
                   'terms'    => $term_id,
               ],
           ],
           'post_status'    => 'publish',
       ];

       $q = new WP_Query($args);

       if (!$q->have_posts()) {
           return false;
       }

       // Перебираємо знайдені товари (хоч один)
       while ($q->have_posts()) {
           $q->the_post();
           $product_id = get_the_ID();

           // Перевіряємо «видимість» продукту
           $is_visible = apply_filters('woocommerce_product_is_visible', true, $product_id);
           if ($is_visible) {
               wp_reset_postdata();
               return true;
           }
       }
       wp_reset_postdata();
       return false;
   }
   ```

4. Якщо **`$is_visible`** `true` для будь-якого товару → виводимо категорію. Якщо ні — пропускаємо.

> **Зауваження**: Якщо плагін Product Visibility / User Roles реалізує видимість через `woocommerce_product_is_visible` або через `woocommerce_is_purchasable`, цей підхід спрацює, адже ми викликаємо `apply_filters('woocommerce_product_is_visible', …)` вручну.

---

### Потенційні зауваження / оптимізація

- **Швидкодія**: якщо категорій дуже багато, ми робитимемо WP_Query на кожну. Це може бути повільно. Для невеликих магазинів — цілком норм.

- Якщо треба, можна створити **один** «груповий» запит (fetch усі товари) і групувати їх по категоріях із `woocommerce_product_is_visible` → потім знати, в яких категоріях з’явився хоч один видимий товар. Але це складніше в реалізації.

- Можна робити кешування результатів. Наприклад, зберігати (transient на 5 хв) список «категорій з видимими товарами» для користувача X. Потім показувати.

---

## Підсумок

- **`hide_empty => true`** не вирішує проблему, бо WooCommerce бачитиме товари опублікованими.
- Для **приховування** категорій, в яких **реально** немає «видимих» для користувача товарів, потрібна **кастомна логіка**.
- Найпростіше — **перевіряти** кожну категорію на наявність хоч одного видимого товару (WP_Query + `woocommerce_product_is_visible`). Якщо знайдено → виводити категорію, інакше ні.

Так ви сховаєте всі «напівпорожні» категорії, в яких товари приховані для поточного юзера.
